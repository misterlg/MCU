/*
*********************************************************************************************************
* HeadFile
*********************************************************************************************************
*/

#include "ntc.h"

/*
*********************************************************************************************************
* Const
*********************************************************************************************************
*/

static const float Rp = 10000.0;                                                 /* 10K                */
static const float T2 = (273.15+25.0);                                           /* T2                 */
static const float Bx = 3435.0;                                                  /* B                  */
static const float Ka = 273.15;

/*
*********************************************************************************************************
* Global Variable
*********************************************************************************************************
*/

uint8_t sensor_flag = 0;

/*
*********************************************************************************************************
* 功  能：获取阻值
* 形  参：ADC值
* 返回值：电阻值
* 备  注：None
* 作  者：LG
* 日  期：2020/11/16
*********************************************************************************************************
*/

static float Get_Resistance(uint16_t adc_value)
{
	float resistance = 0;
	float voltage = 0;
	
	if((adc_value>=4090) || (adc_value<=1))                                      /* 传感器检测         */
	{
		sensor_flag = 1;
		return 10000.0;
	}
	else
		sensor_flag = 0;
	voltage = (float)adc_value * 5 /4095;                                        /* 转换为电压值       */
	resistance = voltage/((5 - voltage)/10000);                                  /* 计算热敏电阻阻值   */
	
	return resistance;  
}

/*
*********************************************************************************************************
* 功  能：获取温度
* 形  参：None
* 返回值：温度值
* 备  注：热敏电阻计算公式 Rt = R *EXP(B*(1/T1-1/T2))
* 作  者：LG
* 日  期：2020/11/16
*********************************************************************************************************
*/

float Get_Temp(void)
{
	float Rt = 0;
	float temp = 0;
	uint16_t adc_value = 0;
	
	adc_value = Get_Adc(); 
	Rt = Get_Resistance(adc_value);
	 
	temp = Rt/Rp;
	temp = log(temp);                                                              /* ln(Rt/Rp)        */
	temp /= Bx;                                                                    /* ln(Rt/Rp)/B      */
	temp += (1/T2);
	temp = 1/(temp);
	temp -= Ka;
	
	return temp;
}
